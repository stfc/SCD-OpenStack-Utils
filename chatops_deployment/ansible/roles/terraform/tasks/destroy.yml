---
- name: Create / check the bastion public key file exists
  ansible.builtin.file:
    path: "../terraform/{{ env }}-bastion-key.pub"
    state: touch
    owner: "{{ ansible_env.USER }}"
    group: "{{ ansible_env.USER }}"
    mode: "0774"

- name: Destroy infrastructure
  community.general.terraform:
    project_path: "../terraform"
    state: absent
    complex_vars: true
    workspace: "{{ env }}"
    variables:
      deployment: "{{ terraform_deployment }}"
      external_network_id: "{{ terraform_external_network_id }}"
      floating_ip: "{{ terraform_floating_ip }}"

- name: Remove generated files
  block:
    - name: Delete terraform.tfvars file
      ansible.builtin.file:
        path: "../terraform/terraform.tfvars"
        state: absent

    - name: Remove private key file
      ansible.builtin.file:
        path: "{{ env }}-bastion-key"
        state: absent

    - name: Remove public key file
      ansible.builtin.file:
        path: "../terraform/{{ env }}-bastion-key.pub"
        state: absent
